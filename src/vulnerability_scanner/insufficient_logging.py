"""
Insufficient Logging and Monitoring testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_insufficient_logging(base_url):
    """
    Test for insufficient logging and monitoring.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Test endpoints that should be logged but might not be
    sensitive_endpoints = [
        "/admin", "/login", "/logout", "/delete", "/update",
        "/api/admin", "/api/user", "/api/private",
        "/sensitive", "/secret", "/config"
    ]

    for endpoint in sensitive_endpoints:
        try:
            test_url = urljoin(base_url, endpoint)
            response = requests.get(test_url, timeout=5)

            # Check if sensitive operations don't return proper logging indicators
            if response.status_code in [200, 403, 401]:
                # These endpoints should ideally be logged
                # Since we can't check server logs, we look for lack of monitoring indicators
                content = response.text.lower()

                # If there's no mention of logging or monitoring, it might be insufficient
                logging_indicators = [
                    "logged", "audit", "monitor", "track",
                    "session", "activity", "access"
                ]

                # This is a weak detection - in practice, logging happens server-side
                # We can only detect if client-side indicates logging
                if not any(indicator in content for indicator in logging_indicators):
                    # This is more of an informational finding
                    pass

        except requests.RequestException:
            continue

    # Test for error handling that doesn't log properly
    error_endpoints = [
        "/nonexistent", "/error", "/404", "/500",
        "/api/nonexistent", "/invalid/path"
    ]

    for endpoint in error_endpoints:
        try:
            test_url = urljoin(base_url, endpoint)
            response = requests.get(test_url, timeout=5)

            if response.status_code >= 400:
                content = response.text.lower()

                # Check if error pages provide detailed information (which might indicate poor logging)
                error_details = [
                    "stack trace", "exception", "traceback",
                    "debug", "internal error", "sql error"
                ]

                if any(detail in content for detail in error_details):
                    vulnerabilities.append({
                        "type": "Insufficient Logging",
                        "endpoint": test_url,
                        "payload": "N/A",
                        "method": "GET",
                        "evidence": "Error details exposed without proper logging context"
                    })

        except requests.RequestException:
            continue

    return vulnerabilities
