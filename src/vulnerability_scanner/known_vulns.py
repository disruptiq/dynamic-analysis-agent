"""
Known Vulnerabilities detection for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_known_vulnerabilities(base_url):
    """
    Test for known vulnerabilities in common components.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Common vulnerable paths and versions
    vulnerable_paths = [
        ("/adminer.php", "Adminer database tool", "1.0-4.8.1"),
        ("/phpmyadmin/", "phpMyAdmin", "4.8.x"),
        ("/wp-admin/", "WordPress admin", "various"),
        ("/wp-content/", "WordPress content", "various"),
        ("/administrator/", "Joomla admin", "various"),
        ("/joomla/", "Joomla installation", "various"),
        ("/drupal/", "Drupal installation", "various"),
        ("/roundcube/", "RoundCube webmail", "1.4.x"),
        ("/squirrelmail/", "SquirrelMail", "1.4.x"),
        ("/horde/", "Horde webmail", "5.x"),
        ("/webmail/", "Generic webmail", "various"),
        ("/cgi-bin/", "CGI scripts", "various"),
        ("/.well-known/", "Well-known URIs", "various")
    ]

    for path, component, affected_versions in vulnerable_paths:
        try:
            test_url = urljoin(base_url, path)
            response = requests.get(test_url, timeout=5)

            if response.status_code == 200:
                content = response.text.lower()

                # Check for version information or component identification
                version_indicators = [
                    "version", "ver", "v1", "v2", "v3", "v4", "v5",
                    component.lower().replace(" ", ""),
                    "adminer", "phpmyadmin", "wordpress", "joomla", "drupal"
                ]

                if any(indicator in content for indicator in version_indicators):
                    vulnerabilities.append({
                        "type": "Known Vulnerable Component",
                        "endpoint": test_url,
                        "payload": "N/A",
                        "method": "GET",
                        "evidence": f"{component} detected (potentially vulnerable versions: {affected_versions})"
                    })

        except requests.RequestException:
            continue

    # Check for outdated software headers
    try:
        response = requests.get(base_url, timeout=5)

        # Check server header for known vulnerable versions
        server_header = response.headers.get('Server', '')

        vulnerable_servers = {
            "Apache/2.2": "Apache HTTP Server 2.2 (end of life)",
            "Apache/2.4.1": "Apache HTTP Server 2.4.1-2.4.39 (multiple CVEs)",
            "nginx/1.10": "nginx 1.10.x (multiple vulnerabilities)",
            "nginx/1.12": "nginx 1.12.x (multiple vulnerabilities)",
            "IIS/6.0": "IIS 6.0 (end of life)",
            "IIS/7.0": "IIS 7.0 (known vulnerabilities)"
        }

        for version, description in vulnerable_servers.items():
            if version in server_header:
                vulnerabilities.append({
                    "type": "Known Vulnerable Component",
                    "endpoint": base_url,
                    "payload": "N/A",
                    "method": "GET",
                    "evidence": f"Outdated server software: {description}"
                })
                break

    except requests.RequestException:
        pass

    return vulnerabilities
