"""
CORS (Cross-Origin Resource Sharing) misconfiguration testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_cors_misconfiguration(base_url):
    """
    Test for CORS misconfiguration vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Common endpoints to test for CORS
    test_endpoints = [
        base_url,
        urljoin(base_url, "/api"),
        urljoin(base_url, "/api/data"),
        urljoin(base_url, "/api/user"),
        urljoin(base_url, "/api/admin"),
        urljoin(base_url, "/data"),
        urljoin(base_url, "/user"),
        urljoin(base_url, "/admin")
    ]

    # Test different origins
    test_origins = [
        "https://evil.com",
        "https://attacker.com",
        "http://localhost:3000",
        "null",
        "*"
    ]

    for endpoint in test_endpoints:
        for origin in test_origins:
            try:
                headers = {
                    'Origin': origin,
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }

                # Test with OPTIONS request (preflight)
                response = requests.options(endpoint, headers=headers, timeout=5)

                # Check CORS headers
                cors_headers = {
                    'access-control-allow-origin': response.headers.get('Access-Control-Allow-Origin', ''),
                    'access-control-allow-credentials': response.headers.get('Access-Control-Allow-Credentials', ''),
                    'access-control-allow-methods': response.headers.get('Access-Control-Allow-Methods', ''),
                    'access-control-allow-headers': response.headers.get('Access-Control-Allow-Headers', ''),
                    'access-control-expose-headers': response.headers.get('Access-Control-Expose-Headers', ''),
                    'access-control-max-age': response.headers.get('Access-Control-Max-Age', '')
                }

                # Check for overly permissive configurations
                if cors_headers['access-control-allow-origin'] == '*':
                    if cors_headers['access-control-allow-credentials'] == 'true':
                        vulnerabilities.append({
                            "type": "CORS Misconfiguration",
                            "endpoint": endpoint,
                            "payload": f"Origin: {origin}",
                            "method": "OPTIONS",
                            "evidence": "CORS allows all origins (*) with credentials - dangerous combination"
                        })
                    else:
                        vulnerabilities.append({
                            "type": "CORS Misconfiguration",
                            "endpoint": endpoint,
                            "payload": f"Origin: {origin}",
                            "method": "OPTIONS",
                            "evidence": "CORS allows all origins (*) - potentially too permissive"
                        })

                # Check if evil origin is allowed
                if cors_headers['access-control-allow-origin'] == origin and origin in ["https://evil.com", "https://attacker.com"]:
                    vulnerabilities.append({
                        "type": "CORS Misconfiguration",
                        "endpoint": endpoint,
                        "payload": f"Origin: {origin}",
                        "method": "OPTIONS",
                        "evidence": f"CORS allows potentially malicious origin: {origin}"
                    })

                # Check for null origin allowance (can be dangerous)
                if cors_headers['access-control-allow-origin'] == 'null':
                    vulnerabilities.append({
                        "type": "CORS Misconfiguration",
                        "endpoint": endpoint,
                        "payload": "Origin: null",
                        "method": "OPTIONS",
                        "evidence": "CORS allows null origin - can be exploited"
                    })

                # Check for missing CORS headers where they should exist
                if not cors_headers['access-control-allow-origin']:
                    # This might not be a vulnerability, but worth noting
                    pass

                # Test with GET request as well
                response_get = requests.get(endpoint, headers={'Origin': origin}, timeout=5)
                get_cors_origin = response_get.headers.get('Access-Control-Allow-Origin', '')

                if get_cors_origin == '*' and response_get.headers.get('Access-Control-Allow-Credentials') == 'true':
                    vulnerabilities.append({
                        "type": "CORS Misconfiguration",
                        "endpoint": endpoint,
                        "payload": f"GET Origin: {origin}",
                        "method": "GET",
                        "evidence": "GET request allows all origins (*) with credentials"
                    })

            except requests.RequestException:
                continue

    # Test for CORS on login endpoints specifically
    login_endpoints = [
        urljoin(base_url, "/login"),
        urljoin(base_url, "/signin"),
        urljoin(base_url, "/auth")
    ]

    for endpoint in login_endpoints:
        try:
            response = requests.options(endpoint, headers={'Origin': 'https://evil.com'}, timeout=5)
            cors_origin = response.headers.get('Access-Control-Allow-Origin', '')

            if cors_origin == 'https://evil.com':
                vulnerabilities.append({
                    "type": "CORS Misconfiguration on Auth Endpoint",
                    "endpoint": endpoint,
                    "payload": "Origin: https://evil.com",
                    "method": "OPTIONS",
                    "evidence": "Authentication endpoint allows CORS from evil origin"
                })

        except requests.RequestException:
            continue

    return vulnerabilities
