"""
Template Injection testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_template_injection(base_url):
    """
    Test for template injection vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    template_payloads = [
        "{{7*7}}", "${7*7}", "<%= 7*7 %>",
        "{{config}}", "${config}", "<%= config %>",
        "{{self.__class__}}", "${self.class}", "<%= self.class %>"
    ]

    test_endpoints = [
        urljoin(base_url, "/template"),
        urljoin(base_url, "/render"),
        urljoin(base_url, "/view"),
        urljoin(base_url, "/page")
    ]

    for endpoint in test_endpoints:
        for payload in template_payloads:
            try:
                params = {"template": payload, "content": payload, "data": payload}
                response = requests.get(endpoint, params=params, timeout=5)

                # Look for template execution results
                if "49" in response.text or "config" in response.text.lower() or "class" in response.text.lower():
                    vulnerabilities.append({
                        "type": "Template Injection",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "GET",
                        "evidence": "Template executed successfully"
                    })

            except requests.RequestException:
                continue

    return vulnerabilities
