"""
Format String vulnerability testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_format_string(base_url):
    """
    Test for format string vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    format_payloads = [
        "%s", "%x", "%p", "%n",
        "%s%x%p%n", "AAAA%x%x%x%x",
        "%08x%08x%08x%08x", "%d%d%d%d"
    ]

    test_endpoints = [
        urljoin(base_url, "/print"),
        urljoin(base_url, "/debug"),
        urljoin(base_url, "/log"),
        urljoin(base_url, "/printf"),
        urljoin(base_url, "/format")
    ]

    for endpoint in test_endpoints:
        for payload in format_payloads:
            try:
                params = {"format": payload, "msg": payload, "data": payload}
                response = requests.get(endpoint, params=params, timeout=5)

                # Look for format string exploitation indicators
                format_indicators = [
                    "0x", "41414141", "61616161",  # Hex values, AAAA, aaaa
                    "segmentation fault", "format error",
                    "printf", "format string"
                ]

                response_text = response.text.lower()
                if any(indicator in response_text for indicator in format_indicators):
                    vulnerabilities.append({
                        "type": "Format String Vulnerability",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "GET",
                        "evidence": "Format specifiers processed, potential vulnerability"
                    })

            except requests.RequestException:
                continue

    return vulnerabilities
