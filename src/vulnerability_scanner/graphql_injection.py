"""
GraphQL Injection testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_graphql_injection(base_url):
    """
    Test for GraphQL injection vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    graphql_payloads = [
        '{__schema{types{name}}}', '{__type(name: "Query"){fields{name}}}',
        '{"query": "{__schema{types{name}}}"}', 'query { __typename }',
        '{ user(id: 1) { name password } }', '{ users { name email } }'
    ]

    test_endpoints = [
        urljoin(base_url, "/graphql"),
        urljoin(base_url, "/api/graphql"),
        urljoin(base_url, "/graph"),
        urljoin(base_url, "/api/graph")
    ]

    for endpoint in test_endpoints:
        for payload in graphql_payloads:
            try:
                if payload.startswith('{'):
                    # Direct GraphQL query
                    response = requests.post(endpoint, json={"query": payload}, timeout=5)
                else:
                    # JSON payload
                    response = requests.post(endpoint, json=json.loads(payload), timeout=5)

                graphql_indicators = [
                    "__schema", "__type", "__typename",
                    "introspection", "graphql", "query",
                    "mutation", "subscription"
                ]

                response_text = response.text.lower()
                if any(indicator in response_text for indicator in graphql_indicators):
                    vulnerabilities.append({
                        "type": "GraphQL Injection",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "POST",
                        "evidence": "GraphQL schema/introspection accessible"
                    })

            except (requests.RequestException, json.JSONDecodeError):
                continue

    return vulnerabilities
