"""
Insecure Deserialization vulnerability testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin
import base64
import pickle

def test_insecure_deserialization(base_url):
    """
    Test for Insecure Deserialization vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Common endpoints that might accept serialized data
    test_endpoints = [
        urljoin(base_url, "/deserialize"),
        urljoin(base_url, "/unserialize"),
        urljoin(base_url, "/api/deserialize"),
        urljoin(base_url, "/load"),
        urljoin(base_url, "/import"),
        urljoin(base_url, "/process"),
        urljoin(base_url, "/upload"),
        urljoin(base_url, "/data")
    ]

    # Common parameter names that might accept serialized data
    param_names = [
        'data', 'serialized', 'object', 'pickle', 'payload',
        'input', 'content', 'file', 'upload', 'state'
    ]

    # Test payloads for different serialization formats
    test_payloads = {
        'python_pickle': base64.b64encode(pickle.dumps({'test': 'data'})).decode(),
        'java_serialized': 'rO0ABXNyABNqYXZhLnV0aWwuQXJyYXlMaXN0eIiBa3pEjY0CAAhJABNpbmRleEkABHNpemV4cAAAAAF3BAAAAAF0AAVidA==',  # Base64 encoded Java ArrayList
        'php_serialized': 'TzoyOiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjQ6InRlc3QiO3M6ODoicGFzc3dvcmQiO3M6NDoidGVzdCI7fQ==',  # PHP serialized User object
        'yaml_payload': '!!python/object:__main__.MyClass\nattribute: value',
        'json_pickle': '{"py/object": "os.system", "py/repr": "os.system(\'echo vulnerable\')"}'
    }

    for endpoint in test_endpoints:
        for param in param_names:
            for payload_type, payload in test_payloads.items():
                try:
                    # Test with POST data
                    data = {param: payload}
                    response = requests.post(endpoint, data=data, timeout=5)

                    # Check for deserialization-related errors
                    error_indicators = [
                        'deserialization', 'unserialize', 'pickle', 'serialization',
                        'object', 'class', 'module', 'attributeerror', 'typeerror',
                        'insecure', 'vulnerable', 'exploit', 'code execution'
                    ]

                    content_lower = response.text.lower()
                    headers_str = str(response.headers).lower()

                    has_error = any(indicator in content_lower or indicator in headers_str for indicator in error_indicators)

                    # Check for successful execution indicators
                    success_indicators = [
                        'echo vulnerable', 'command executed', 'system call',
                        'file created', 'data processed'
                    ]

                    has_success = any(indicator in content_lower for indicator in success_indicators)

                    if has_error or has_success or response.status_code in [500, 400]:
                        vulnerabilities.append({
                            "type": "Insecure Deserialization",
                            "endpoint": endpoint,
                            "payload": f"{payload_type}: {payload[:50]}...",
                            "method": "POST",
                            "evidence": f"Potential deserialization vulnerability detected with {payload_type} payload"
                        })

                except requests.RequestException:
                    continue

                try:
                    # Test with GET parameters
                    params = {param: payload}
                    response = requests.get(endpoint, params=params, timeout=5)

                    content_lower = response.text.lower()
                    has_error = any(indicator in content_lower for indicator in [
                        'deserialization', 'unserialize', 'pickle', 'serialization',
                        'object', 'class', 'module', 'attributeerror', 'typeerror'
                    ])

                    if has_error or response.status_code in [500, 400]:
                        vulnerabilities.append({
                            "type": "Insecure Deserialization",
                            "endpoint": endpoint,
                            "payload": f"GET {payload_type}: {payload[:50]}...",
                            "method": "GET",
                            "evidence": f"Potential deserialization error with {payload_type} payload"
                        })

                except requests.RequestException:
                    continue

    # Test for Java-specific deserialization
    java_endpoints = [
        urljoin(base_url, "/api/java"),
        urljoin(base_url, "/java/deserialize"),
        urljoin(base_url, "/spring/unmarshal")
    ]

    java_payload = "rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHAAFmAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAF0AAR0ZXN0dAAEdGVzdHg="  # Java HashMap

    for endpoint in java_endpoints:
        try:
            response = requests.post(endpoint, data={'object': java_payload}, timeout=5)
            if 'java' in response.text.lower() and response.status_code != 200:
                vulnerabilities.append({
                    "type": "Java Insecure Deserialization",
                    "endpoint": endpoint,
                    "payload": "Java serialized HashMap",
                    "method": "POST",
                    "evidence": "Potential Java deserialization vulnerability"
                })
        except requests.RequestException:
            continue

    return vulnerabilities
