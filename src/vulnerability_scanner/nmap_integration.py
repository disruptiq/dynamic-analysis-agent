"""
Nmap integration for network scanning capabilities.
"""

import subprocess
import re
from urllib.parse import urlparse

def test_nmap_integration(base_url):
    """
    Integrate with Nmap for network-level vulnerability scanning.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Extract host from URL
    parsed = urlparse(base_url)
    host = parsed.hostname

    if not host:
        return vulnerabilities

    # Check if nmap is available
    try:
        result = subprocess.run(['nmap', '--version'], capture_output=True, text=True, timeout=10)
        if result.returncode != 0:
            # Nmap not available, return informational message
            vulnerabilities.append({
                "type": "Tool Integration",
                "endpoint": base_url,
                "payload": "N/A",
                "method": "N/A",
                "evidence": "Nmap not installed - network scanning unavailable"
            })
            return vulnerabilities
    except (subprocess.TimeoutExpired, FileNotFoundError):
        vulnerabilities.append({
            "type": "Tool Integration",
            "endpoint": base_url,
            "payload": "N/A",
            "method": "N/A",
            "evidence": "Nmap not available - install for network scanning"
        })
        return vulnerabilities

    # Run basic port scan
    try:
        cmd = ['nmap', '-p', '1-1000', '--open', host]
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=60)

        if result.returncode == 0:
            output = result.stdout

            # Parse open ports
            open_ports = re.findall(r'(\d+)/tcp\s+open', output)

            dangerous_ports = {
                '21': 'FTP - potential anonymous access',
                '23': 'Telnet - unencrypted protocol',
                '25': 'SMTP - potential open relay',
                '53': 'DNS - potential DNS poisoning',
                '110': 'POP3 - unencrypted email',
                '143': 'IMAP - unencrypted email',
                '445': 'SMB - potential file sharing vulnerabilities',
                '3389': 'RDP - potential remote desktop exposure',
                '8080': 'HTTP Alternate - potential web server',
                '8443': 'HTTPS Alternate - potential web server'
            }

            for port in open_ports:
                if port in dangerous_ports:
                    vulnerabilities.append({
                        "type": "Open Dangerous Port",
                        "endpoint": f"{host}:{port}",
                        "payload": f"Nmap scan: {port}/tcp open",
                        "method": "N/A",
                        "evidence": dangerous_ports[port]
                    })

            # Check for web ports that might indicate multiple servers
            web_ports = ['80', '443', '8080', '8443', '3000', '5000', '8000', '9000']
            web_open = [p for p in open_ports if p in web_ports]

            if len(web_open) > 1:
                vulnerabilities.append({
                    "type": "Multiple Web Servers Detected",
                    "endpoint": host,
                    "payload": f"Open web ports: {', '.join(web_open)}",
                    "method": "N/A",
                    "evidence": "Multiple web servers running - potential configuration issues"
                })

        else:
            vulnerabilities.append({
                "type": "Nmap Scan Failed",
                "endpoint": host,
                "payload": "N/A",
                "method": "N/A",
                "evidence": f"Nmap command failed: {result.stderr}"
            })

    except subprocess.TimeoutExpired:
        vulnerabilities.append({
            "type": "Nmap Scan Timeout",
            "endpoint": host,
            "payload": "N/A",
            "method": "N/A",
            "evidence": "Nmap scan timed out - host may be slow or blocking scans"
        })

    # Run vulnerability scan if available
    try:
        cmd = ['nmap', '-sV', '--script', 'vuln', host]
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=120)

        if result.returncode == 0:
            output = result.stdout

            # Parse for vulnerabilities
            vuln_lines = [line for line in output.split('\n') if 'VULNERABLE' in line or 'vulnerable' in line.lower()]

            for line in vuln_lines:
                vulnerabilities.append({
                    "type": "Nmap Vulnerability Detection",
                    "endpoint": host,
                    "payload": line.strip(),
                    "method": "N/A",
                    "evidence": "Nmap vuln script detected vulnerability"
                })

        else:
            # Vuln scripts might not be available
            pass

    except subprocess.TimeoutExpired:
        pass

    return vulnerabilities
