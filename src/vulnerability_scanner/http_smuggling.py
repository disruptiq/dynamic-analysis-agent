"""
HTTP Request Smuggling testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_http_request_smuggling(base_url):
    """
    Test for HTTP request smuggling vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # CL.TE (Content-Length + Transfer-Encoding) smuggling
    smuggling_payloads = [
        "POST / HTTP/1.1\r\nHost: localhost\r\nContent-Length: 0\r\nTransfer-Encoding: chunked\r\n\r\n0\r\n\r\nGET /admin HTTP/1.1\r\nHost: localhost\r\n\r\n",
        "POST / HTTP/1.1\r\nHost: localhost\r\nContent-Length: 13\r\n\r\nmalicious\r\n0\r\n\r\nGET /admin HTTP/1.1\r\n\r\n",
        "GET / HTTP/1.1\r\nHost: localhost\r\nTransfer-Encoding: chunked\r\n\r\n0\r\n\r\nGET /admin HTTP/1.1\r\n\r\n"
    ]

    test_endpoints = [
        urljoin(base_url, "/"),
        urljoin(base_url, "/api/"),
        urljoin(base_url, "/proxy")
    ]

    for endpoint in test_endpoints:
        for payload in smuggling_payloads:
            try:
                # Send raw HTTP request
                response = requests.post(endpoint, data=payload, timeout=5)

                # Check for smuggling indicators
                if response.status_code in [200, 404] and "admin" in response.url:
                    vulnerabilities.append({
                        "type": "HTTP Request Smuggling",
                        "endpoint": endpoint,
                        "payload": "CL.TE variant",
                        "method": "POST",
                        "evidence": "Request smuggling successful - admin endpoint accessed"
                    })

            except requests.RequestException:
                continue

    return vulnerabilities
