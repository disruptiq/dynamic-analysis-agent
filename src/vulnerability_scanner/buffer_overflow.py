"""
Buffer Overflow testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_buffer_overflow(base_url):
    """
    Test for buffer overflow vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Large payloads to test for buffer overflows
    large_payloads = [
        "A" * 1000,
        "A" * 10000,
        "%s" * 100,
        "\\x41" * 500,
        "../" * 200
    ]

    test_endpoints = [
        urljoin(base_url, "/search"),
        urljoin(base_url, "/input"),
        urljoin(base_url, "/upload"),
        urljoin(base_url, "/api/input"),
        urljoin(base_url, "/form")
    ]

    for endpoint in test_endpoints:
        for payload in large_payloads:
            try:
                params = {"input": payload, "data": payload, "search": payload}
                response = requests.get(endpoint, params=params, timeout=10)

                # Look for crash indicators or unusual responses
                crash_indicators = [
                    "segmentation fault", "buffer overflow", "stack overflow",
                    "access violation", "null pointer", "heap corruption",
                    "internal server error", "500", "crashed"
                ]

                response_text = response.text.lower()
                if any(indicator in response_text for indicator in crash_indicators):
                    vulnerabilities.append({
                        "type": "Buffer Overflow",
                        "endpoint": endpoint,
                        "payload": f"Large payload ({len(payload)} chars)",
                        "method": "GET",
                        "evidence": "Application crashed or returned overflow error"
                    })

                # Check for response size anomalies (might indicate overflow handling)
                if len(response.text) > 100000:  # Very large response
                    vulnerabilities.append({
                        "type": "Buffer Overflow",
                        "endpoint": endpoint,
                        "payload": f"Large payload ({len(payload)} chars)",
                        "method": "GET",
                        "evidence": "Unusually large response may indicate overflow"
                    })

            except requests.RequestException:
                # Timeout or connection error might indicate crash
                vulnerabilities.append({
                    "type": "Buffer Overflow",
                    "endpoint": endpoint,
                    "payload": f"Large payload ({len(payload)} chars)",
                    "method": "GET",
                    "evidence": "Request timeout/connection error may indicate crash"
                })

    return vulnerabilities
