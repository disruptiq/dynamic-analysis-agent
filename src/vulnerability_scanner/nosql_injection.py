"""
NoSQL Injection testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin
import json

def test_nosql_injection(base_url):
    """
    Test for NoSQL injection vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    nosql_payloads = [
        '{"$ne": null}', '{"$gt": ""}', '{"$where": "1==1"}',
        '{"$or": [{"password": {"$ne": null}}]}', '{"$regex": ".*"}',
        '|| true', '&& false', '{"username": {"$ne": null}}'
    ]

    test_endpoints = [
        urljoin(base_url, "/nosql"),
        urljoin(base_url, "/api/search"),
        urljoin(base_url, "/api/user"),
        urljoin(base_url, "/search")
    ]

    for endpoint in test_endpoints:
        for payload in nosql_payloads:
            try:
                data = {"query": payload, "search": payload, "filter": payload}
                response = requests.post(endpoint, json=data, timeout=5)

                nosql_errors = [
                    "mongodb", "nosql", "operator", "syntax error",
                    "$ne", "$gt", "$where", "aggregate"
                ]

                response_text = response.text.lower()
                if any(error in response_text for error in nosql_errors):
                    vulnerabilities.append({
                        "type": "NoSQL Injection",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "POST",
                        "evidence": "NoSQL operator processed"
                    })

            except requests.RequestException:
                continue

    return vulnerabilities
