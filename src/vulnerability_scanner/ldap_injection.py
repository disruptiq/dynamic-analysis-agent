"""
LDAP Injection testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_ldap_injection(base_url):
    """
    Test for LDAP injection vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    ldap_payloads = [
        "*", ")(", ")*(", ")(&",
        "admin*)(", ")(|(cn=*))",
        ")(uid=*))(|(uid=*", "*)(uid=*"
    ]

    test_endpoints = [
        urljoin(base_url, "/ldap"),
        urljoin(base_url, "/search"),
        urljoin(base_url, "/user"),
        urljoin(base_url, "/auth"),
        urljoin(base_url, "/api/ldap")
    ]

    for endpoint in test_endpoints:
        for payload in ldap_payloads:
            try:
                params = {"username": payload, "user": payload, "cn": payload, "uid": payload}
                response = requests.get(endpoint, params=params, timeout=5)

                # Look for LDAP error indicators
                ldap_errors = [
                    "ldap", "invalid dn", "bad search filter",
                    "ldap error", "filter error", "syntax error"
                ]

                response_text = response.text.lower()
                if any(error in response_text for error in ldap_errors):
                    vulnerabilities.append({
                        "type": "LDAP Injection",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "GET",
                        "evidence": "LDAP error detected, possible injection"
                    })

            except requests.RequestException:
                continue

    return vulnerabilities
