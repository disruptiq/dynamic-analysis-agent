"""
Security Misconfiguration testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_security_misconfiguration(base_url):
    """
    Test for security misconfiguration vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Test for common misconfiguration indicators
    misconfig_endpoints = [
        urljoin(base_url, "/.env"),
        urljoin(base_url, "/.git/"),
        urljoin(base_url, "/.git/config"),
        urljoin(base_url, "/.svn/"),
        urljoin(base_url, "/.DS_Store"),
        urljoin(base_url, "/backup/"),
        urljoin(base_url, "/backups/"),
        urljoin(base_url, "/tmp/"),
        urljoin(base_url, "/temp/"),
        urljoin(base_url, "/logs/"),
        urljoin(base_url, "/error.log"),
        urljoin(base_url, "/access.log"),
        urljoin(base_url, "/debug.log"),
        urljoin(base_url, "/server-status"),
        urljoin(base_url, "/server-info"),
        urljoin(base_url, "/phpinfo.php"),
        urljoin(base_url, "/test.php"),
        urljoin(base_url, "/info.php"),
        urljoin(base_url, "/wp-config.php"),
        urljoin(base_url, "/config.php"),
        urljoin(base_url, "/settings.php"),
        urljoin(base_url, "/database.php"),
        urljoin(base_url, "/adminer.php"),
        urljoin(base_url, "/phpmyadmin/"),
        urljoin(base_url, "/.well-known/security.txt"),
        urljoin(base_url, "/crossdomain.xml"),
        urljoin(base_url, "/clientaccesspolicy.xml"),
        urljoin(base_url, "/trace.axd"),
        urljoin(base_url, "/elmah.axd"),
        urljoin(base_url, "/WEB-INF/"),
        urljoin(base_url, "/META-INF/")
    ]

    for endpoint in misconfig_endpoints:
        try:
            response = requests.get(endpoint, timeout=5)

            if response.status_code == 200:
                content = response.text.lower()

                # Check for exposed sensitive files
                sensitive_files = {
                    ".env": "Environment configuration",
                    ".git/config": "Git repository configuration",
                    ".svn/entries": "SVN repository data",
                    ".DS_Store": "macOS directory metadata",
                    "wp-config.php": "WordPress configuration",
                    "config.php": "PHP configuration file",
                    "phpinfo.php": "PHP information disclosure",
                    "error.log": "Application error logs",
                    "access.log": "Access logs",
                    "backup.sql": "Database backup",
                    "adminer.php": "Database administration tool",
                    "server-status": "Apache server status",
                    "server-info": "Apache server information"
                }

                for filename, description in sensitive_files.items():
                    if filename in endpoint:
                        vulnerabilities.append({
                            "type": "Security Misconfiguration",
                            "endpoint": endpoint,
                            "payload": "N/A",
                            "method": "GET",
                            "evidence": f"{description} file exposed"
                        })
                        break

                # Check for directory listing
                if "index of" in content or "directory listing" in content:
                    vulnerabilities.append({
                        "type": "Security Misconfiguration",
                        "endpoint": endpoint,
                        "payload": "N/A",
                        "method": "GET",
                        "evidence": "Directory listing enabled"
                    })

        except requests.RequestException:
            continue

    # Test for default credentials and pages
    default_pages = [
        urljoin(base_url, "/admin"),
        urljoin(base_url, "/administrator"),
        urljoin(base_url, "/manager"),
        urljoin(base_url, "/webadmin"),
        urljoin(base_url, "/cpanel"),
        urljoin(base_url, "/plesk"),
        urljoin(base_url, "/phpmyadmin"),
        urljoin(base_url, "/mysql"),
        urljoin(base_url, "/sql"),
        urljoin(base_url, "/dbadmin"),
        urljoin(base_url, "/adminer"),
        urljoin(base_url, "/test"),
        urljoin(base_url, "/demo"),
        urljoin(base_url, "/example")
    ]

    for page in default_pages:
        try:
            response = requests.get(page, timeout=5)

            if response.status_code == 200:
                content = response.text.lower()

                # Check for default admin/login pages
                admin_indicators = [
                    "admin", "login", "password", "username",
                    "dashboard", "control panel", "management",
                    "administrator", "superuser"
                ]

                if any(indicator in content for indicator in admin_indicators):
                    vulnerabilities.append({
                        "type": "Security Misconfiguration",
                        "endpoint": page,
                        "payload": "N/A",
                        "method": "GET",
                        "evidence": "Default administrative interface accessible"
                    })

        except requests.RequestException:
            continue

    # Test for insecure HTTP methods
    try:
        # Test TRACE method (can lead to XSS)
        response = requests.request("TRACE", base_url, timeout=5)
        if response.status_code == 200 and "TRACE" in response.text:
            vulnerabilities.append({
                "type": "Security Misconfiguration",
                "endpoint": base_url,
                "payload": "HTTP TRACE",
                "method": "TRACE",
                "evidence": "HTTP TRACE method enabled (potential XSS vulnerability)"
            })

    except requests.RequestException:
        pass

    # Test for missing security headers
    try:
        response = requests.get(base_url, timeout=5)

        # Check for missing security headers
        missing_headers = []

        security_headers = {
            "X-Frame-Options": "Clickjacking protection",
            "X-Content-Type-Options": "MIME type sniffing protection",
            "X-XSS-Protection": "XSS filter",
            "Content-Security-Policy": "Content Security Policy",
            "Strict-Transport-Security": "HTTPS enforcement",
            "Referrer-Policy": "Referrer control"
        }

        for header, description in security_headers.items():
            if header not in response.headers:
                missing_headers.append(description)

        if missing_headers:
            vulnerabilities.append({
                "type": "Security Misconfiguration",
                "endpoint": base_url,
                "payload": "N/A",
                "method": "GET",
                "evidence": f"Missing security headers: {', '.join(missing_headers[:3])}"
            })

    except requests.RequestException:
        pass

    return vulnerabilities
