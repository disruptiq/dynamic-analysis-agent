"""
Broken Access Control testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_broken_access_control(base_url):
    """
    Test for broken access control vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Test for common protected endpoints that might have broken access controls
    protected_endpoints = [
        "/admin", "/admin/dashboard", "/admin/users", "/admin/settings",
        "/user/profile", "/user/settings", "/user/dashboard",
        "/api/admin", "/api/user", "/api/private",
        "/dashboard", "/profile", "/settings",
        "/superadmin", "/root", "/manager",
        "/backup", "/logs", "/debug"
    ]

    # Test parameter-based access control bypass
    parameter_bypass = [
        "?admin=true", "?role=admin", "?user_id=1", "?access=1",
        "?debug=true", "?bypass=true", "?godmode=1",
        "?is_admin=1", "?superuser=true", "?root=true"
    ]

    for endpoint in protected_endpoints:
        full_url = urljoin(base_url, endpoint)

        # Test direct access without authentication
        try:
            response = requests.get(full_url, timeout=5)

            # If we get a 200 response, it might be publicly accessible
            if response.status_code == 200:
                content = response.text.lower()

                # Check if this looks like an admin/user page
                admin_indicators = [
                    "admin", "dashboard", "settings", "users", "management",
                    "control panel", "administrator", "superuser"
                ]

                if any(indicator in content for indicator in admin_indicators):
                    vulnerabilities.append({
                        "type": "Broken Access Control",
                        "endpoint": full_url,
                        "payload": "Direct access",
                        "method": "GET",
                        "evidence": "Protected admin/user content accessible without authentication"
                    })

        except requests.RequestException:
            continue

        # Test parameter-based bypass
        for param in parameter_bypass:
            try:
                test_url = full_url + param
                response = requests.get(test_url, timeout=5)

                if response.status_code == 200:
                    content = response.text.lower()
                    admin_indicators = ["admin", "dashboard", "settings", "users", "root"]

                    if any(indicator in content for indicator in admin_indicators):
                        vulnerabilities.append({
                            "type": "Broken Access Control",
                            "endpoint": test_url,
                            "payload": param,
                            "method": "GET",
                            "evidence": "Parameter-based access control bypass successful"
                        })

            except requests.RequestException:
                continue

    # Test for IDOR (Insecure Direct Object References)
    idor_endpoints = [
        "/user/", "/profile/", "/account/", "/api/user/",
        "/data/", "/file/", "/document/"
    ]

    for endpoint in idor_endpoints:
        # Test accessing other users' data
        for user_id in ["1", "2", "admin", "root", "0", "-1"]:
            try:
                test_url = urljoin(base_url, f"{endpoint.rstrip('/')}/{user_id}")
                response = requests.get(test_url, timeout=5)

                if response.status_code == 200:
                    content = response.text.lower()

                    # Look for user-specific data
                    user_indicators = [
                        "user", "profile", "account", "email", "name",
                        "settings", "preferences", "dashboard"
                    ]

                    if any(indicator in content for indicator in user_indicators):
                        vulnerabilities.append({
                            "type": "Broken Access Control - IDOR",
                            "endpoint": test_url,
                            "payload": f"ID: {user_id}",
                            "method": "GET",
                            "evidence": "Able to access other users' data via direct object reference"
                        })

            except requests.RequestException:
                continue

    # Test for method-based access control bypass
    method_bypass_tests = [
        (urljoin(base_url, "/admin/users"), "DELETE"),
        (urljoin(base_url, "/user/settings"), "PUT"),
        (urljoin(base_url, "/api/admin"), "POST"),
        (urljoin(base_url, "/admin/config"), "PATCH")
    ]

    for test_url, method in method_bypass_tests:
        try:
            if method == "DELETE":
                response = requests.delete(test_url, timeout=5)
            elif method == "PUT":
                response = requests.put(test_url, json={}, timeout=5)
            elif method == "POST":
                response = requests.post(test_url, json={}, timeout=5)
            elif method == "PATCH":
                response = requests.patch(test_url, json={}, timeout=5)

            if response.status_code in [200, 201, 204]:
                vulnerabilities.append({
                    "type": "Broken Access Control",
                    "endpoint": test_url,
                    "payload": f"HTTP {method}",
                    "method": method,
                    "evidence": f"HTTP method {method} allowed on protected endpoint"
                })

        except requests.RequestException:
            continue

    return vulnerabilities
