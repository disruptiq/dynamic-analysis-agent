"""
Host Header Injection testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_host_header_injection(base_url):
    """
    Test for Host header injection vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    host_payloads = [
        "evil.com", "127.0.0.1", "localhost",
        "evil.com:8080", "127.0.0.1:22", "localhost:8000"
    ]

    test_endpoints = [
        urljoin(base_url, "/"),
        urljoin(base_url, "/redirect"),
        urljoin(base_url, "/reset-password"),
        urljoin(base_url, "/api/reset")
    ]

    for endpoint in test_endpoints:
        for payload in host_payloads:
            try:
                headers = {"Host": payload}
                response = requests.get(endpoint, headers=headers, timeout=5)

                # Check if host header is reflected or affects behavior
                if payload in response.text or "evil.com" in response.url:
                    vulnerabilities.append({
                        "type": "Host Header Injection",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "GET",
                        "evidence": "Host header processed and reflected"
                    })

            except requests.RequestException:
                continue

    return vulnerabilities
