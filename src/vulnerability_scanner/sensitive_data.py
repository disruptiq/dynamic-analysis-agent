"""
Sensitive Data Exposure testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin
import re

def test_sensitive_data_exposure(base_url):
    """
    Test for sensitive data exposure vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Test endpoints that might expose sensitive data
    test_endpoints = [
        urljoin(base_url, "/api/users"),
        urljoin(base_url, "/api/user"),
        urljoin(base_url, "/users"),
        urljoin(base_url, "/admin/users"),
        urljoin(base_url, "/debug"),
        urljoin(base_url, "/config"),
        urljoin(base_url, "/.env"),
        urljoin(base_url, "/.git/config"),
        urljoin(base_url, "/backup.sql"),
        urljoin(base_url, "/database.sql"),
        urljoin(base_url, "/wp-config.php"),
        urljoin(base_url, "/config.php"),
        urljoin(base_url, "/settings.py"),
        urljoin(base_url, "/secrets"),
        urljoin(base_url, "/credentials"),
        urljoin(base_url, "/logs"),
        urljoin(base_url, "/error.log"),
        urljoin(base_url, "/access.log")
    ]

    # Patterns that indicate sensitive data exposure
    sensitive_patterns = {
        "password": r"password['\"]?[:=]\s*['\"]?[^\s'\"&]+",
        "api_key": r"api[_-]?key['\"]?[:=]\s*['\"]?[^\s'\"&]+",
        "secret": r"secret['\"]?[:=]\s*['\"]?[^\s'\"&]+",
        "token": r"token['\"]?[:=]\s*['\"]?[^\s'\"&]+",
        "aws_key": r"AKIA[0-9A-Z]{16}",
        "private_key": r"-----BEGIN\s+(?:RSA\s+)?PRIVATE\s+KEY-----",
        "credit_card": r"\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b",
        "ssn": r"\b\d{3}[\s-]?\d{2}[\s-]?\d{4}\b",
        "email": r"\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b",
        "phone": r"\b\d{3}[\s.-]?\d{3}[\s.-]?\d{4}\b",
        "database_url": r"(?:mysql|postgresql|mongodb|redis)://[^\s\"']+",
        "internal_ip": r"\b10\.\d{1,3}\.\d{1,3}\.\d{1,3}\b|\b192\.168\.\d{1,3}\.\d{1,3}\b|\b172\.(?:1[6-9]|2\d|3[0-1])\.\d{1,3}\.\d{1,3}\b"
    }

    for endpoint in test_endpoints:
        try:
            response = requests.get(endpoint, timeout=5)
            content = response.text

            if response.status_code == 200:
                content_lower = content.lower()

                # Check for sensitive data patterns
                for data_type, pattern in sensitive_patterns.items():
                    matches = re.findall(pattern, content, re.IGNORECASE)
                    if matches:
                        # Limit to first few matches to avoid spam
                        sample_matches = matches[:3]
                        vulnerabilities.append({
                            "type": "Sensitive Data Exposure",
                            "endpoint": endpoint,
                            "payload": "N/A",
                            "method": "GET",
                            "evidence": f"{data_type.upper()} data found: {', '.join(sample_matches)}"
                        })

                # Check for common sensitive files
                sensitive_files = [
                    ".env", "config.php", "settings.php", "database.php",
                    ".git/config", ".svn/entries", ".DS_Store",
                    "backup.sql", "dump.sql", "database.sql"
                ]

                for filename in sensitive_files:
                    if filename in endpoint and response.status_code == 200:
                        vulnerabilities.append({
                            "type": "Sensitive Data Exposure",
                            "endpoint": endpoint,
                            "payload": "N/A",
                            "method": "GET",
                            "evidence": f"Sensitive file {filename} accessible"
                        })

                # Check for directory listing
                if "index of" in content_lower or "<title>directory listing" in content_lower:
                    vulnerabilities.append({
                        "type": "Sensitive Data Exposure",
                        "endpoint": endpoint,
                        "payload": "N/A",
                        "method": "GET",
                        "evidence": "Directory listing enabled"
                    })

                # Check for error messages that expose internal information
                error_patterns = [
                    "stack trace", "exception", "fatal error",
                    "sql syntax", "database error", "connection failed",
                    "undefined index", "undefined variable"
                ]

                if any(pattern in content_lower for pattern in error_patterns):
                    vulnerabilities.append({
                        "type": "Sensitive Data Exposure",
                        "endpoint": endpoint,
                        "payload": "N/A",
                        "method": "GET",
                        "evidence": "Error messages expose internal information"
                    })

        except requests.RequestException:
            continue

    # Test for HTTP vs HTTPS
    try:
        https_url = base_url.replace("http://", "https://")
        https_response = requests.get(https_url, timeout=5, verify=False)

        # If HTTPS works but HTTP also works, data might be transmitted insecurely
        if https_response.status_code == 200:
            http_response = requests.get(base_url, timeout=5)
            if http_response.status_code == 200:
                vulnerabilities.append({
                    "type": "Sensitive Data Exposure",
                    "endpoint": base_url,
                    "payload": "HTTP available",
                    "method": "GET",
                    "evidence": "Application accessible via insecure HTTP protocol"
                })

    except requests.RequestException:
        pass

    return vulnerabilities
