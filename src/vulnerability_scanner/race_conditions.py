"""
Race Condition testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin
import threading
import time

def test_race_conditions(base_url):
    """
    Test for race condition vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Test endpoints that might be vulnerable to race conditions
    race_endpoints = [
        "/transfer", "/withdraw", "/purchase", "/redeem",
        "/api/transfer", "/api/purchase", "/api/withdraw",
        "/balance", "/points", "/credits"
    ]

    for endpoint in race_endpoints:
        try:
            test_url = urljoin(base_url, endpoint)

            # Make multiple concurrent requests to test for race conditions
            results = []
            errors = []

            def make_request():
                try:
                    response = requests.post(test_url, json={"amount": "1"}, timeout=5)
                    results.append((response.status_code, response.text))
                except Exception as e:
                    errors.append(str(e))

            # Launch 10 concurrent requests
            threads = []
            for i in range(10):
                t = threading.Thread(target=make_request)
                threads.append(t)
                t.start()
                time.sleep(0.1)  # Slight delay to create race condition

            for t in threads:
                t.join(timeout=10)

            # Analyze results
            success_count = sum(1 for status, _ in results if status in [200, 201])
            error_count = len(errors)

            # If multiple requests succeeded when they shouldn't, it might indicate a race condition
            if success_count > 1:
                vulnerabilities.append({
                    "type": "Race Condition",
                    "endpoint": test_url,
                    "payload": "10 concurrent requests",
                    "method": "POST",
                    "evidence": f"Multiple concurrent operations succeeded: {success_count}/{len(results)}"
                })

        except Exception as e:
            continue

    return vulnerabilities
