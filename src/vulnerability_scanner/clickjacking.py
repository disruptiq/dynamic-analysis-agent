"""
Clickjacking vulnerability detection for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_clickjacking(base_url):
    """
    Test for Clickjacking vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    # Common endpoints to test for clickjacking protection
    test_endpoints = [
        base_url,
        urljoin(base_url, "/login"),
        urljoin(base_url, "/admin"),
        urljoin(base_url, "/dashboard"),
        urljoin(base_url, "/user"),
        urljoin(base_url, "/profile"),
        urljoin(base_url, "/settings"),
        urljoin(base_url, "/api"),
        urljoin(base_url, "/app")
    ]

    for endpoint in test_endpoints:
        try:
            response = requests.get(endpoint, timeout=5)

            # Check for frame-busting headers
            headers = response.headers

            # X-Frame-Options header
            x_frame_options = headers.get('X-Frame-Options', '').upper()
            allowed_values = ['DENY', 'SAMEORIGIN']

            # Content-Security-Policy frame-ancestors
            csp = headers.get('Content-Security-Policy', '')
            has_frame_ancestors = 'frame-ancestors' in csp

            # Check if page contains frame-busting JavaScript
            content = response.text.lower()
            has_frame_buster_js = any(js in content for js in [
                'top.location', 'self.location', 'parent.location',
                'window.top', 'window.self', 'window.parent'
            ])

            # Determine if vulnerable
            is_vulnerable = True

            if x_frame_options in allowed_values:
                is_vulnerable = False
            elif has_frame_ancestors:
                # Parse CSP for frame-ancestors
                csp_parts = csp.split(';')
                for part in csp_parts:
                    if 'frame-ancestors' in part:
                        frame_ancestors_value = part.split('frame-ancestors')[1].strip()
                        if frame_ancestors_value not in ["'none'", "'self'"]:
                            # If it allows other origins, might still be vulnerable
                            pass
                        else:
                            is_vulnerable = False
                        break
            elif has_frame_buster_js:
                is_vulnerable = False  # Assuming JS protection is in place

            if is_vulnerable:
                evidence_parts = []
                if not x_frame_options:
                    evidence_parts.append("Missing X-Frame-Options header")
                elif x_frame_options not in allowed_values:
                    evidence_parts.append(f"X-Frame-Options: {x_frame_options} (not restrictive enough)")

                if not has_frame_ancestors:
                    evidence_parts.append("Missing frame-ancestors in CSP")

                if not has_frame_buster_js:
                    evidence_parts.append("No frame-busting JavaScript detected")

                vulnerabilities.append({
                    "type": "Clickjacking Vulnerability",
                    "endpoint": endpoint,
                    "payload": "N/A",
                    "method": "GET",
                    "evidence": "; ".join(evidence_parts)
                })

            # Additional checks for CSP misconfigurations
            if csp and 'frame-ancestors' in csp:
                csp_parts = csp.split(';')
                for part in csp_parts:
                    if 'frame-ancestors' in part:
                        frame_ancestors_value = part.split('frame-ancestors')[1].strip()
                        if "'none'" not in frame_ancestors_value and "'self'" not in frame_ancestors_value:
                            # Check if it allows wildcard or specific domains
                            if '*' in frame_ancestors_value or 'http:' in frame_ancestors_value:
                                vulnerabilities.append({
                                    "type": "CSP Frame-Ancestors Misconfiguration",
                                    "endpoint": endpoint,
                                    "payload": f"CSP: {csp}",
                                    "method": "GET",
                                    "evidence": f"frame-ancestors allows: {frame_ancestors_value} - potentially too permissive"
                                })
                        break

        except requests.RequestException:
            continue

    # Test for specific high-risk pages
    high_risk_pages = [
        urljoin(base_url, "/admin/delete"),
        urljoin(base_url, "/user/delete"),
        urljoin(base_url, "/transfer"),
        urljoin(base_url, "/change-password"),
        urljoin(base_url, "/withdraw")
    ]

    for endpoint in high_risk_pages:
        try:
            response = requests.get(endpoint, timeout=5)
            if response.status_code == 200:
                x_frame = response.headers.get('X-Frame-Options', '')
                if not x_frame:
                    vulnerabilities.append({
                        "type": "Clickjacking on High-Risk Action",
                        "endpoint": endpoint,
                        "payload": "N/A",
                        "method": "GET",
                        "evidence": "High-risk action page missing X-Frame-Options protection"
                    })
        except requests.RequestException:
            continue

    return vulnerabilities
