"""
HTTP Parameter Pollution (HPP) testing for the Dynamic Analysis Agent.
"""

import requests
from urllib.parse import urljoin

def test_http_parameter_pollution(base_url):
    """
    Test for HTTP Parameter Pollution vulnerabilities.

    Args:
        base_url (str): Base URL to test

    Returns:
        list: List of detected vulnerabilities
    """
    vulnerabilities = []

    test_endpoints = [
        urljoin(base_url, "/search"),
        urljoin(base_url, "/filter"),
        urljoin(base_url, "/api/search"),
        urljoin(base_url, "/query")
    ]

    for endpoint in test_endpoints:
        try:
            # Test parameter pollution with different values
            params = {"q": ["safe", "malicious"], "search": ["normal", "<script>alert('xss')</script>"]}
            response = requests.get(endpoint, params=params, timeout=5)

            # Check if both parameters are processed (indicating pollution)
            if "<script>" in response.text and "safe" in response.text:
                vulnerabilities.append({
                    "type": "HTTP Parameter Pollution",
                    "endpoint": endpoint,
                    "payload": "q=safe&q=malicious",
                    "method": "GET",
                    "evidence": "Multiple parameters with same name processed"
                })

        except requests.RequestException:
            continue

    return vulnerabilities
