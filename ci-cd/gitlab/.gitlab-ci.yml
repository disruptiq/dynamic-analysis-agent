stages:
  - build
  - test
  - security_scan
  - deploy

variables:
  DOCKER_IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
  SCAN_RESULTS_DIR: results

# Build the security scanner Docker image
build_scanner:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker info
  script:
    - docker build -t $DOCKER_IMAGE_TAG -f Dockerfile .
    - docker push $DOCKER_IMAGE_TAG
  only:
    - main
    - develop
    - merge_requests

# Run security scan on the built application
security_scan:
  stage: security_scan
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  before_script:
    - apk add --no-cache jq curl
    - mkdir -p $SCAN_RESULTS_DIR
  script:
    # Pull the scanner image
    - docker pull $DOCKER_IMAGE_TAG

    # Determine target image (use built image or specified one)
    - |
      if [ -n "$TARGET_IMAGE" ]; then
        TARGET="$TARGET_IMAGE"
      elif [ -n "$CI_APPLICATION_TAG" ]; then
        TARGET="$CI_REGISTRY_IMAGE:$CI_APPLICATION_TAG"
      else
        TARGET="nginx:latest"
      fi
      echo "TARGET_IMAGE=$TARGET" >> variables.env

    # Determine ports to scan
    - |
      if [ -n "$TARGET_PORTS" ]; then
        PORTS="$TARGET_PORTS"
      else
        PORTS="80"
      fi
      echo "TARGET_PORTS=$PORTS" >> variables.env

    # Run the security scan
    - |
      docker run --rm \
        -v $(pwd)/$SCAN_RESULTS_DIR:/app/results \
        --network host \
        $DOCKER_IMAGE_TAG \
        python main.py \
        --image $TARGET \
        --port $PORTS \
        --output-format json \
        --output-file results/scan-results.json

    # Generate report
    - |
      echo "## Security Scan Results" > scan_report.md
      echo "" >> scan_report.md
      echo "**Target:** $TARGET" >> scan_report.md
      echo "**Ports:** $PORTS" >> scan_report.md
      echo "**Pipeline:** $CI_PIPELINE_URL" >> scan_report.md
      echo "**Commit:** $CI_COMMIT_SHA" >> scan_report.md
      echo "**Scan Time:** $(date)" >> scan_report.md
      echo "" >> scan_report.md

      if [ -f "$SCAN_RESULTS_DIR/scan-results.json" ]; then
        CRITICAL=$(jq '.vulnerabilities | map(select(.severity == "CRITICAL")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")
        HIGH=$(jq '.vulnerabilities | map(select(.severity == "HIGH")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")
        MEDIUM=$(jq '.vulnerabilities | map(select(.severity == "MEDIUM")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")
        LOW=$(jq '.vulnerabilities | map(select(.severity == "LOW")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")

        echo "### Vulnerability Summary" >> scan_report.md
        echo "- **Critical:** $CRITICAL" >> scan_report.md
        echo "- **High:** $HIGH" >> scan_report.md
        echo "- **Medium:** $MEDIUM" >> scan_report.md
        echo "- **Low:** $LOW" >> scan_report.md
      else
        echo "No scan results found" >> scan_report.md
      fi

  artifacts:
    paths:
      - $SCAN_RESULTS_DIR/
      - scan_report.md
    reports:
      junit: $SCAN_RESULTS_DIR/scan-results.json
    expire_in: 30 days
  allow_failure: true

# Fail pipeline if critical vulnerabilities found (optional)
security_gate:
  stage: security_scan
  image: alpine:latest
  before_script:
    - apk add --no-cache jq
  script:
    - |
      if [ -f "$SCAN_RESULTS_DIR/scan-results.json" ]; then
        CRITICAL_COUNT=$(jq '.vulnerabilities | map(select(.severity == "CRITICAL")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")
        HIGH_COUNT=$(jq '.vulnerabilities | map(select(.severity == "HIGH")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")

        if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 5 ]; then
          echo "❌ Security gate failed: Found $CRITICAL_COUNT critical and $HIGH_COUNT high vulnerabilities"
          exit 1
        else
          echo "✅ Security gate passed"
        fi
      else
        echo "⚠️ No scan results found, skipping security gate"
      fi
  dependencies:
    - security_scan
  allow_failure: true
  only:
    - main
    - develop

# Deploy security reports to GitLab Pages (optional)
pages:
  stage: deploy
  image: alpine:latest
  script:
    - mkdir -p public
    - cp scan_report.md public/index.md
    - cp -r $SCAN_RESULTS_DIR public/ || true
  artifacts:
    paths:
      - public
    expire_in: 30 days
  dependencies:
    - security_scan
  only:
    - main
  allow_failure: true

# Scheduled security scans
scheduled_scan:
  extends: security_scan
  only:
    - schedules
  variables:
    TARGET_IMAGE: "nginx:latest"
    TARGET_PORTS: "80,443"
