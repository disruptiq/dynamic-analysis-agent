language: minimal

services:
  - docker

env:
  global:
    - DOCKER_BUILDKIT=1
    - SCAN_RESULTS_DIR=results
  matrix:
    - TARGET_IMAGE=nginx:latest TARGET_PORTS=80
    - TARGET_IMAGE=httpd:latest TARGET_PORTS=80
    - TARGET_IMAGE=redis:latest TARGET_PORTS=6379

# Only run on main branch and pull requests
branches:
  only:
    - main
    - develop

# Scheduled builds (nightly scans)
cron: nightly

before_install:
  - sudo apt-get update
  - sudo apt-get install -y jq curl

install:
  - echo "Building security scanner..."
  - docker build -t dynamic-analysis-agent:latest -f Dockerfile .

before_script:
  - mkdir -p $SCAN_RESULTS_DIR
  - echo "Starting security scan for $TARGET_IMAGE on ports $TARGET_PORTS"

script:
  # Run the security scan
  - |
    docker run --rm \
      -v $(pwd)/$SCAN_RESULTS_DIR:/app/results \
      --network host \
      dynamic-analysis-agent:latest \
      python main.py \
      --image $TARGET_IMAGE \
      --port $TARGET_PORTS \
      --output-format json \
      --output-file results/scan-results.json

after_script:
  - |
    if [ -f "$SCAN_RESULTS_DIR/scan-results.json" ]; then
      echo "Analyzing scan results..."

      # Extract vulnerability counts
      CRITICAL=$(jq '.vulnerabilities | map(select(.severity == "CRITICAL")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")
      HIGH=$(jq '.vulnerabilities | map(select(.severity == "HIGH")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")
      MEDIUM=$(jq '.vulnerabilities | map(select(.severity == "MEDIUM")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")
      LOW=$(jq '.vulnerabilities | map(select(.severity == "LOW")) | length' $SCAN_RESULTS_DIR/scan-results.json 2>/dev/null || echo "0")

      echo "Vulnerability Summary:"
      echo "  Critical: $CRITICAL"
      echo "  High: $HIGH"
      echo "  Medium: $MEDIUM"
      echo "  Low: $LOW"

      # Generate summary report
      echo "# Security Scan Report" > $SCAN_RESULTS_DIR/summary.md
      echo "" >> $SCAN_RESULTS_DIR/summary.md
      echo "**Travis CI Build:** $TRAVIS_BUILD_WEB_URL" >> $SCAN_RESULTS_DIR/summary.md
      echo "**Target:** $TARGET_IMAGE" >> $SCAN_RESULTS_DIR/summary.md
      echo "**Ports:** $TARGET_PORTS" >> $SCAN_RESULTS_DIR/summary.md
      echo "**Scan Time:** $(date)" >> $SCAN_RESULTS_DIR/summary.md
      echo "" >> $SCAN_RESULTS_DIR/summary.md
      echo "## Vulnerability Summary" >> $SCAN_RESULTS_DIR/summary.md
      echo "- Critical: $CRITICAL" >> $SCAN_RESULTS_DIR/summary.md
      echo "- High: $HIGH" >> $SCAN_RESULTS_DIR/summary.md
      echo "- Medium: $MEDIUM" >> $SCAN_RESULTS_DIR/summary.md
      echo "- Low: $LOW" >> $SCAN_RESULTS_DIR/summary.md

      # Check for critical vulnerabilities (fail build if found)
      if [ "$CRITICAL" -gt 0 ]; then
        echo "❌ Build failed: Found $CRITICAL critical vulnerabilities"
        exit 1
      fi

      echo "✅ Security scan completed successfully"
    else
      echo "⚠️ No scan results found"
      exit 1
    fi

# Deploy scan results to GitHub releases (optional)
deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file: $SCAN_RESULTS_DIR/*
  skip_cleanup: true
  on:
    tags: true
    condition: $TRAVIS_TAG =~ ^v

# Notifications
notifications:
  email:
    recipients:
      - security@yourcompany.com
    on_success: change
    on_failure: always

  slack:
    rooms:
      - yourcompany:yourtoken#security-scans
    on_success: change
    on_failure: always

  webhooks:
    urls:
      - https://your-webhook-url.com/travis
    on_success: always
    on_failure: always
    on_start: always

# Cache Docker layers to speed up builds
cache:
  directories:
    - /tmp/.docker-cache

before_cache:
  - docker save dynamic-analysis-agent:latest > /tmp/.docker-cache/dynamic-analysis-agent.tar

after_success:
  - docker load < /tmp/.docker-cache/dynamic-analysis-agent.tar || true

# Matrix builds for different targets
jobs:
  include:
    - name: "Security Scan - Nginx"
      env: TARGET_IMAGE=nginx:latest TARGET_PORTS=80
    - name: "Security Scan - Apache"
      env: TARGET_IMAGE=httpd:latest TARGET_PORTS=80
    - name: "Security Scan - Redis"
      env: TARGET_IMAGE=redis:latest TARGET_PORTS=6379
    - name: "Security Scan - PostgreSQL"
      env: TARGET_IMAGE=postgres:latest TARGET_PORTS=5432
      if: branch = main
    - name: "Extended Scan - Multiple Ports"
      env: TARGET_IMAGE=nginx:latest TARGET_PORTS=80,443,8080
      if: type = cron

  allow_failures:
    - env: TARGET_IMAGE=redis:latest TARGET_PORTS=6379

  fast_finish: true

# Environment variables for configuration
env:
  global:
    - CI=true
    - DOCKER_CLI_EXPERIMENTAL=enabled

# Stages for complex workflows
stages:
  - name: build
  - name: scan
    if: branch IN (main, develop)
  - name: report
    if: branch = main

# Build stage (optional - if you want to build your app first)
build:
  stage: build
  script:
    - echo "Building application..."
    # Add your application build steps here
    - echo "Application built successfully"

# Scan stage
scan:
  stage: scan
  script: skip  # Scan logic is in the main script section

# Report stage
report:
  stage: report
  script:
    - echo "Generating comprehensive security report..."
    - |
      if [ -f "$SCAN_RESULTS_DIR/scan-results.json" ]; then
        # Generate additional reports or send to external systems
        echo "Report generation completed"
      fi
