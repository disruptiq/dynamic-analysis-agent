version: 2.1

parameters:
  target_image:
    type: string
    default: "nginx:latest"
  target_ports:
    type: string
    default: "80"
  output_format:
    type: enum
    enum: ["json", "html", "pdf", "csv"]
    default: "json"
  fail_on_critical:
    type: boolean
    default: true
  fail_on_high:
    type: boolean
    default: false

executors:
  docker-executor:
    docker:
      - image: cimg/base:2023.09
    resource_class: medium
    environment:
      DOCKER_BUILDKIT: 1

commands:
  install_dependencies:
    steps:
      - run:
          name: Install Docker CLI and jq
          command: |
            sudo apt-get update
            sudo apt-get install -y docker.io jq curl

  build_scanner:
    parameters:
      tag:
        type: string
        default: "latest"
    steps:
      - run:
          name: Build security scanner image
          command: |
            docker build -t dynamic-analysis-agent:<< parameters.tag >> -f Dockerfile .

  run_security_scan:
    parameters:
      target_image:
        type: string
      target_ports:
        type: string
      output_format:
        type: string
        default: "json"
      results_dir:
        type: string
        default: "results"
    steps:
      - run:
          name: Create results directory
          command: mkdir -p << parameters.results_dir >>

      - run:
          name: Run security scan
          command: |
            docker run --rm \
              -v $(pwd)/<< parameters.results_dir >>:/app/results \
              --network host \
              dynamic-analysis-agent:latest \
              python main.py \
              --image << parameters.target_image >> \
              --port << parameters.target_ports >> \
              --output-format << parameters.output_format >> \
              --output-file results/scan-results.<< parameters.output_format >>

  analyze_results:
    parameters:
      results_dir:
        type: string
        default: "results"
      fail_on_critical:
        type: boolean
        default: true
      fail_on_high:
        type: boolean
        default: false
    steps:
      - run:
          name: Analyze scan results
          command: |
            RESULTS_FILE="<< parameters.results_dir >>/scan-results.json"

            if [ -f "$RESULTS_FILE" ]; then
              echo "Analyzing scan results..."

              # Extract vulnerability counts
              CRITICAL=$(jq '.vulnerabilities | map(select(.severity == "CRITICAL")) | length' "$RESULTS_FILE" 2>/dev/null || echo "0")
              HIGH=$(jq '.vulnerabilities | map(select(.severity == "HIGH")) | length' "$RESULTS_FILE" 2>/dev/null || echo "0")
              MEDIUM=$(jq '.vulnerabilities | map(select(.severity == "MEDIUM")) | length' "$RESULTS_FILE" 2>/dev/null || echo "0")
              LOW=$(jq '.vulnerabilities | map(select(.severity == "LOW")) | length' "$RESULTS_FILE" 2>/dev/null || echo "0")

              echo "Vulnerability Summary:"
              echo "  Critical: $CRITICAL"
              echo "  High: $HIGH"
              echo "  Medium: $MEDIUM"
              echo "  Low: $LOW"

              # Set environment variables for other steps
              echo "export CRITICAL_COUNT=$CRITICAL" >> $BASH_ENV
              echo "export HIGH_COUNT=$HIGH" >> $BASH_ENV
              echo "export MEDIUM_COUNT=$MEDIUM" >> $BASH_ENV
              echo "export LOW_COUNT=$LOW" >> $BASH_ENV

              # Check failure conditions
              FAILURE=false

              if [ "<< parameters.fail_on_critical >>" = "true" ] && [ "$CRITICAL" -gt 0 ]; then
                echo "❌ Failing build due to $CRITICAL critical vulnerabilities"
                FAILURE=true
              fi

              if [ "<< parameters.fail_on_high >>" = "true" ] && [ "$HIGH" -gt 0 ]; then
                echo "❌ Failing build due to $HIGH high vulnerabilities"
                FAILURE=true
              fi

              if [ "$FAILURE" = "true" ]; then
                exit 1
              else
                echo "✅ Security scan passed"
              fi
            else
              echo "⚠️ No scan results file found"
              exit 1
            fi

  generate_report:
    parameters:
      results_dir:
        type: string
        default: "results"
      target_image:
        type: string
      target_ports:
        type: string
    steps:
      - run:
          name: Generate security report
          command: |
            REPORT_FILE="<< parameters.results_dir >>/security-report.md"

            echo "# Security Scan Report" > "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**CircleCI Build:** $CIRCLE_BUILD_URL" >> "$REPORT_FILE"
            echo "**Target Image:** << parameters.target_image >>" >> "$REPORT_FILE"
            echo "**Target Ports:** << parameters.target_ports >>" >> "$REPORT_FILE"
            echo "**Scan Time:** $(date)" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "## Vulnerability Summary" >> "$REPORT_FILE"
            echo "- Critical: \${CRITICAL_COUNT:-0}" >> "$REPORT_FILE"
            echo "- High: \${HIGH_COUNT:-0}" >> "$REPORT_FILE"
            echo "- Medium: \${MEDIUM_COUNT:-0}" >> "$REPORT_FILE"
            echo "- Low: \${LOW_COUNT:-0}" >> "$REPORT_FILE"

workflows:
  security_scan:
    jobs:
      - security_scan_job:
          context:
            - docker-hub-creds  # Add this context for Docker Hub access if needed

  nightly_scan:
    triggers:
      - schedule:
          cron: "0 2 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - security_scan_job:
          target_image: "nginx:latest"
          target_ports: "80,443"
          fail_on_critical: false
          fail_on_high: false

jobs:
  security_scan_job:
    parameters:
      target_image:
        type: string
        default: "<< pipeline.parameters.target_image >>"
      target_ports:
        type: string
        default: "<< pipeline.parameters.target_ports >>"
      output_format:
        type: string
        default: "<< pipeline.parameters.output_format >>"
      fail_on_critical:
        type: boolean
        default: "<< pipeline.parameters.fail_on_critical >>"
      fail_on_high:
        type: boolean
        default: "<< pipeline.parameters.fail_on_high >>"
      results_dir:
        type: string
        default: "scan-results"

    executor: docker-executor

    steps:
      - checkout

      - install_dependencies

      - build_scanner

      - run_security_scan:
          target_image: << parameters.target_image >>
          target_ports: << parameters.target_ports >>
          output_format: << parameters.output_format >>
          results_dir: << parameters.results_dir >>

      - analyze_results:
          results_dir: << parameters.results_dir >>
          fail_on_critical: << parameters.fail_on_critical >>
          fail_on_high: << parameters.fail_on_high >>

      - generate_report:
          results_dir: << parameters.results_dir >>
          target_image: << parameters.target_image >>
          target_ports: << parameters.target_ports >>

      - store_artifacts:
          path: << parameters.results_dir >>
          destination: security-scan-results

      - store_test_results:
          path: << parameters.results_dir >>

# Orb definition for reuse
orbs:
  security-scan: dynamic-analysis-agent/security-scan@1.0.0

# Example usage of the orb (would be defined separately)
example_orb_usage:
  jobs:
    - security-scan/scan:
        target_image: "myapp:latest"
        target_ports: "8080,8443"
        fail_on_critical: true
        context:
          - docker-hub-creds
